{% extends 'base.html' %}
{% block title %}Form {{ form_level }} - {{ exam.name }} Analysis{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3">Form {{ form_level }} - {{ exam.name }} Analysis</h1>
            <p class="text-muted">{{ exam.term|title }} {{ exam.year }}</p>
        </div>
    </div>

    <!-- Subject Performance Cards -->
    <div class="row mb-4">
        <div class="col-12">
            <h4>Subject Performance</h4>
        </div>
    </div>
    <div class="subject-cards-grid mb-5">
        {% for subject_data in subject_performance %}
        <a href="{% url 'school:exam_subject_analysis' form_level exam.id subject_data.subject.id %}" class="subject-card">
            <div class="subject-icon">
                <i class="fas fa-book"></i>
            </div>
            <div class="subject-content">
                <h5>{{ subject_data.subject.name }}</h5>
                <p>Avg: {{ subject_data.avg_marks }}</p>
                <p>Max: {{ subject_data.max_marks }}</p>
                <small>{{ subject_data.student_count }} students</small>
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- Combined Class Results Table -->
    <div class="row mb-4">
        <div class="col-12">
            <h4>Combined Class Results</h4>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Position</th>
                    <th>Name</th>
                    <th>Admission No</th>
                    <th>Stream</th>
                    <th>Subjects</th>
                    <th>No. Subjects</th>
                    <th>Total Marks</th>
                    <th>Mean Marks</th>
                    <th>Grade</th>
                    <th>Total Points</th>
                    <th>Dev</th>
                    <th>Stream Pos</th>
                    <th>Class Pos</th>
                </tr>
            </thead>
            <tbody>
                {% for summary in summaries %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ summary.student.get_full_name }}</td>
                    <td>{{ summary.student.admission_number }}</td>
                    <td>{{ summary.student.stream }}</td>
                    <td>-</td>
                    <td>{{ summary.subject_count }}</td>
                    <td>{{ summary.total_marks|floatformat:1 }}</td>
                    <td>{{ summary.mean_marks|floatformat:1 }}</td>
                    <td>{{ summary.mean_grade }}</td>
                    <td>{{ summary.total_points }}</td>
                    <td>-</td>
                    <td>{{ summary.stream_position }}</td>
                    <td>{{ forloop.counter }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Stream Links -->
    <div class="row mt-4">
        <div class="col-12">
            <h4>Stream Analysis</h4>
        </div>
    </div>
    <div class="stream-links">
        {% for stream in summaries|slice:":1" %}
        <a href="{% url 'school:exam_stream_analysis' form_level exam.id stream.student.stream %}" class="btn btn-outline-primary mr-2 mb-2">
            {{ stream.student.stream }} Stream
        </a>
        {% endfor %}
    </div>
</div>

<style>
.subject-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.subject-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    text-decoration: none;
    color: inherit;
}

.subject-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.subject-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--light-blue);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-green);
}

.subject-content h5 {
    margin: 0 0 5px 0;
    font-size: 1rem;
    font-weight: 600;
}

.subject-content p {
    margin: 0;
    font-size: 0.8rem;
    color: var(--gray-text);
}

.subject-content small {
    color: var(--gray-text);
    font-size: 0.7rem;
}

.table th {
    font-weight: 600;
    font-size: 0.85rem;
}

.table td {
    font-size: 0.85rem;
}

.stream-links {
    margin-top: 20px;
}
</style>
{% endblock %}