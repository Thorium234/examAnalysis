{% extends 'base.html' %}
{% load static %}
{% block title %}Stream Results - {{ stream }} - {{ exam.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow-lg border-0 rounded-lg mt-5">
                <div class="card-header bg-info text-white py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <i class="fas fa-users mr-2"></i>Form {{ form_level }} {{ stream }} Results
                            </h3>
                            <p class="mb-0 mt-2">{{ exam.name }} - {{ exam.get_exam_type_display }}</p>
                        </div>
                        <div class="text-right">
                            <h5 class="mb-0">Class Teacher</h5>
                            <p class="mb-0">{{ class_teacher.get_full_name|default:"Not Assigned" }}</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Stream Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h5 class="text-primary">{{ stream_results|length }}</h5>
                                    <p class="mb-0">Students</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h5 class="text-success">{{ stream_stats.highest_total }}</h5>
                                    <p class="mb-0">Highest Total</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h5 class="text-warning">{{ stream_stats.mean_total|floatformat:1 }}</h5>
                                    <p class="mb-0">Mean Total</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <h5 class="text-danger">{{ stream_stats.lowest_total }}</h5>
                                    <p class="mb-0">Lowest Total</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <h5 class="text-info">{{ stream_stats.mean_grade }}</h5>
                                    <p class="mb-0">Mean Grade</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h5 class="text-secondary">{{ stream_stats.mean_points|floatformat:1 }}</h5>
                                    <p class="mb-0">Mean Points</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Navigation -->
                    <div class="mb-4">
                        <h5>Quick Subject Access:</h5>
                        <div class="d-flex flex-wrap">
                            {% for subject in subjects %}
                            <a href="{% url 'exams:subject_results' exam.id subject.id %}"
                               class="btn btn-outline-primary btn-sm mr-2 mb-2">
                                {{ subject.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="streamResultsTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Position</th>
                                    <th>Adm No</th>
                                    <th>Student Name</th>
                                    {% for subject in subjects %}
                                    <th>{{ subject.name }}</th>
                                    {% endfor %}
                                    <th>Total Marks</th>
                                    <th>Mean Marks</th>
                                    <th>Grade</th>
                                    <th>Points</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in stream_results %}
                                <tr>
                                    <td>
                                        <strong>{{ result.stream_position }}</strong>
                                    </td>
                                    <td>{{ result.student.admission_number }}</td>
                                    <td>{{ result.student.name }}</td>
                                    {% for subject in subjects %}
                                    <td>
                                        {% with subject_result=result.subject_results|get_item:subject.id %}
                                        {% if subject_result %}
                                            {{ subject_result.final_marks }}
                                            <small class="text-muted">({{ subject_result.grade }})</small>
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% endwith %}
                                    </td>
                                    {% endfor %}
                                    <td><strong>{{ result.total_marks }}</strong></td>
                                    <td>{{ result.mean_marks|floatformat:1 }}</td>
                                    <td>
                                        <span class="badge badge-{% if result.mean_grade == 'A' %}success{% elif result.mean_grade == 'B' %}primary{% elif result.mean_grade == 'C' %}warning{% elif result.mean_grade == 'D' %}danger{% else %}secondary{% endif %}">
                                            {{ result.mean_grade }}
                                        </span>
                                    </td>
                                    <td>{{ result.total_points }}</td>
                                    <td>
                                        {% if result.status == 'complete' %}
                                            <span class="badge badge-success">Complete</span>
                                        {% elif result.status == 'incomplete' %}
                                            <span class="badge badge-warning">Incomplete</span>
                                        {% else %}
                                            <span class="badge badge-secondary">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{{ subjects|length|add:9 }}" class="text-center py-4">
                                        <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                                        <p class="text-muted">No results found for this stream.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Navigation -->
                    <div class="text-center mt-4">
                        <a href="{% url 'exams:exam_results_upload_choice' exam.id %}" class="btn btn-secondary mr-3">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Results
                        </a>
                        <a href="{% url 'exams:exam_results_summary' exam.id %}" class="btn btn-primary mr-3">
                            <i class="fas fa-chart-bar mr-2"></i>Exam Summary
                        </a>
                        <button class="btn btn-success" onclick="exportStreamResults()">
                            <i class="fas fa-download mr-2"></i>Export Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#streamResultsTable').DataTable({
        "pageLength": 50,
        "ordering": true,
        "searching": true,
        "order": [[0, "asc"]], // Sort by position by default
        "scrollX": true,
        "fixedColumns": {
            leftColumns: 3
        }
    });
});

function exportStreamResults() {
    // Simple CSV export
    const table = document.getElementById('streamResultsTable');
    let csv = [];

    // Get headers
    const headers = [];
    for (let i = 0; i < table.rows[0].cells.length; i++) {
        headers.push(table.rows[0].cells[i].textContent.trim());
    }
    csv.push(headers.join(','));

    // Get data rows
    for (let i = 1; i < table.rows.length; i++) {
        const row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
            row.push(table.rows[i].cells[j].textContent.trim());
        }
        csv.push(row.join(','));
    }

    // Download CSV
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ exam.name }}_{{ stream }}_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>

<style>
.table th {
    border-top: none;
    font-weight: 600;
    position: sticky;
    top: 0;
    background-color: #343a40;
    color: white;
    z-index: 10;
}

.table td {
    vertical-align: middle;
}

.badge {
    font-size: 0.8em;
}

.card {
    margin-bottom: 2rem;
}

.dataTables_scrollBody {
    border-bottom: 1px solid #dee2e6;
}
</style>
{% endblock %}